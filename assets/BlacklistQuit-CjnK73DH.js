import{a as q,M as g,B as A,Q as O}from"./leancloud-service-D8PKWX6z.js";import{S as T}from"./SearchOutline-D1q6xqfW.js";import{d as U,m as j,g as s,n as z,h as F,i as L,b as D,w as n,u as o,r as I,o as P,e as r,f as R,O as $,q as Q,s as H,k as V,j as E,L as d,H as G,M as J,B as K,_ as W}from"./index-DXhrB1zA.js";import{C as X}from"./CloseCircleOutline-CidRfjFs.js";const Y=U({__name:"BlacklistQuit",setup(Z){const b=j(),i=s(!1),y=s({page:1,pageSize:10,itemCount:0,showSizePicker:!0,pageSizes:[10,20,30,40]}),w=e=>{y.value.page=e},p=s(""),v=s(null),f=s(null);s(null);const _=async e=>{try{i.value=!0;const a=await g.getMember(e.memberId);await g.updateMember(e.memberId,{...a,status:"违规退队"}),await O.addQuitRecord({memberId:e.memberId,memberName:e.memberName,memberQQ:e.memberQQ,quitDate:new Date().toISOString().split("T")[0],reason:"黑点数达到4个",type:"违规退队",quitType:"违规退队"}),m.value=m.value.filter(l=>l.memberId!==e.memberId),b.success("已确认违规退队")}catch(a){console.error("Failed to process quit:",a),b.error("处理失败")}finally{i.value=!1}},N=[{title:"成员昵称",key:"memberName",sorter:(e,a)=>e.memberName.localeCompare(a.memberName)},{title:"QQ号",key:"memberQQ",sorter:(e,a)=>Number(e.memberQQ)-Number(a.memberQQ)},{title:"黑点数量",key:"blacklistCount",sorter:(e,a)=>e.blacklistCount-a.blacklistCount},{title:"状态",key:"status",render:e=>d(G,{type:"error",round:!0},{default:()=>e.status})},{title:"操作",key:"actions",width:80,render:e=>d(Q,{justify:"start",align:"center",size:"small"},{default:()=>[d(J,{onPositiveClick:()=>_(e)},{default:()=>"确认将该成员移至退队名单？",trigger:()=>d(K,{quaternary:!0,circle:!0,size:"small",style:"color: #d03050"},{icon:()=>d(X)})})]})}],C=async()=>{try{i.value=!0;const e=await q.getAllBlacklistQuitRecords(),a=await g.getAllMembers(),l=await A.getAllBlacklistRecords(),c=new Map;return l.forEach(t=>{const u=c.get(t.memberId)||0;c.set(t.memberId,u+1)}),e.map(t=>{const u=a.find(M=>M.objectId===t.memberId);return{id:t.objectId,memberId:t.memberId,memberName:u?u.nickname:"未知成员",memberQQ:u?u.qq:"",blacklistCount:c.get(t.memberId)||0,status:"违规退队"}})}catch(e){return console.error("Failed to load data:",e),b.error("加载数据失败"),[]}finally{i.value=!1}},m=s([]),h=z(()=>{let e=m.value;if(p.value){const a=p.value.toLowerCase();e=e.filter(l=>l.memberName.toLowerCase().includes(a)||l.memberQQ.toLowerCase().includes(a))}return v.value!==null&&(e=e.filter(a=>a.blacklistCount>=v.value)),f.value!==null&&(e=e.filter(a=>a.blacklistCount<=f.value)),e}),B=s([]),S=async()=>{try{const e=await g.getAllMembers();B.value=e.map(a=>({label:`${a.nickname} (${a.qq})${a.gameId?` - ${a.gameId}`:""}`,value:a.objectId}))}catch(e){console.error("Failed to load member options:",e),b.error("加载成员列表失败")}};let k=null;const x=()=>{k=window.setInterval(async()=>{m.value=await C()},6e4)};return F(async()=>{await S(),m.value=await C(),x()}),L(()=>{k&&clearInterval(k)}),(e,a)=>{const l=I("n-input-number"),c=I("n-data-table");return P(),D(o(E),null,{header:n(()=>[r(o($),{style:{margin:"0",color:"#7B1FA2"}},{default:n(()=>a[3]||(a[3]=[R("违规退队")])),_:1})]),default:n(()=>[r(o(Q),{vertical:""},{default:n(()=>[r(o(Q),null,{default:n(()=>[r(o(H),{value:p.value,"onUpdate:value":a[0]||(a[0]=t=>p.value=t),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:n(()=>[r(o(V),null,{default:n(()=>[r(o(T))]),_:1})]),_:1},8,["value"]),r(l,{value:v.value,"onUpdate:value":a[1]||(a[1]=t=>v.value=t),placeholder:"最小黑点数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"]),r(l,{value:f.value,"onUpdate:value":a[2]||(a[2]=t=>f.value=t),placeholder:"最大黑点数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"])]),_:1}),r(c,{columns:N,data:h.value,pagination:y.value,loading:i.value,"onUpdate:page":w},null,8,["data","pagination","loading"])]),_:1})]),_:1})}}}),re=W(Y,[["__scopeId","data-v-0b85180e"]]);export{re as default};
