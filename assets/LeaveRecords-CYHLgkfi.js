import{L as y,M}from"./leancloud-service-D8PKWX6z.js";import{d as W,m as X,g as d,n as q,h as Z,i as ee,c as ae,e as r,w as n,u as s,F as te,r as F,o as A,q as w,f as T,B as h,s as R,k as le,v as j,x as Q,t as re,y as se,b as ne,z as C,K as ue,D as oe,L as g,H as ie,M as de,_ as me}from"./index-DXhrB1zA.js";import{S as ve}from"./SearchOutline-D1q6xqfW.js";import{C as ce}from"./CreateOutline-C305c4EG.js";import{T as pe}from"./TrashOutline-8WT5DdKs.js";const ge=W({__name:"LeaveRecords",setup(fe){const m=X(),v=d(!1),I=async()=>{try{v.value=!0;const a=await y.getAllLeaveRecords(),e=await M.getAllMembers();return a.map(l=>{const o=e.find(i=>i.objectId===l.memberId);return{id:l.objectId,memberId:l.memberId,memberName:o?o.nickname:"未知成员",memberQQ:o?o.qq:"",startDate:l.startDate,endDate:l.endDate,endedDate:l.endedDate||"",status:l.status,reason:l.reason}})}catch(a){return console.error("Failed to load data:",a),m.error("加载数据失败"),[]}finally{v.value=!1}},b=d([]),D=d({page:1,pageSize:10,itemCount:q(()=>_.value.length),showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:a})=>`共 ${a} 条数据`,suffix:({page:a,pageSize:e,pageCount:l})=>`第 ${a} 页 / 共 ${l} 页`}),S=d(""),k=d(null),c=d(null),_=q(()=>{let a=b.value;if(S.value){const e=S.value.toLowerCase();a=a.filter(l=>l.memberName.toLowerCase().includes(e)||l.memberQQ.toLowerCase().includes(e))}if(k.value&&(a=a.filter(e=>e.status===k.value)),c.value&&c.value[0]&&c.value[1]){const e=new Date(c.value[0]).getTime(),l=new Date(c.value[1]).getTime();a=a.filter(o=>{const i=new Date(o.startDate).getTime(),t=new Date(o.endDate).getTime();return i>=e&&i<=l||t>=e&&t<=l||i<=e&&t>=l})}return a}),z=[{title:"昵称",key:"memberName",width:130,sorter:"default"},{title:"QQ号",key:"memberQQ",width:130,sorter:(a,e)=>Number(a.memberQQ)-Number(e.memberQQ)},{title:"起始日期",key:"startDate",width:130,sorter:(a,e)=>new Date(a.startDate).getTime()-new Date(e.startDate).getTime()},{title:"结束日期",key:"endDate",width:130,sorter:(a,e)=>new Date(a.endDate).getTime()-new Date(e.endDate).getTime()},{title:"请假原因",key:"reason",width:200,sorter:"default"},{title:"状态",key:"status",width:100,sorter:(a,e)=>{const l={请假中:0,等待销假:1,已结束:2};return l[a.status]-l[e.status]},render(a){return g(ie,{type:a.status==="请假中"?"warning":a.status==="等待销假"?"info":"success",round:!0},{default:()=>a.status})}},{title:"操作",key:"actions",width:130,render(a){return g(w,{align:"center"},{default:()=>[g(h,{quaternary:!0,circle:!0,size:"small",style:"color: #7B1FA2",onClick:()=>V(a)},{icon:()=>g(ce)}),g(de,{onPositiveClick:()=>Y(a)},{trigger:()=>g(h,{quaternary:!0,circle:!0,size:"small",style:"color: #d03050"},{icon:()=>g(pe)}),default:()=>"确定删除该记录吗？"})]})}}],U=d([]),B=async()=>{try{const a=await M.getAllMembers();U.value=a.map(e=>({label:`${e.nickname} (${e.qq})${e.gameId?` - ${e.gameId}`:""}`,value:e.objectId}))}catch(a){console.error("Failed to load member options:",a),m.error("加载成员列表失败")}},f=d(!1),$=d(null),N=d(null),p=d(!1),u=d({memberId:null,startDate:null,endDate:null,reason:""}),O={memberId:{required:!0,message:"请选择成员",trigger:["blur","change"]},startDate:{required:!0,message:"请选择起始日期",trigger:["blur","change"],validator:(a,e)=>e?Promise.resolve():Promise.reject(a.message)},endDate:{required:!0,message:"请选择结束日期",trigger:["blur","change"],validator:(a,e)=>e?u.value.startDate?e>=u.value.startDate?Promise.resolve():Promise.reject("结束日期不能早于起始日期"):Promise.reject("请先选择起始日期"):Promise.reject(a.message)},reason:{required:!0,message:"请填写请假原因",trigger:["blur","change"]}},E=()=>{p.value=!1,N.value=null,u.value={memberId:null,startDate:null,endDate:null,reason:""},f.value=!0},V=a=>{p.value=!0,N.value=a.id;const[e,l,o]=a.startDate.split("-").map(Number),[i,t,P]=a.endDate.split("-").map(Number);u.value={memberId:a.memberId,startDate:Date.UTC(e,l-1,o),endDate:Date.UTC(i,t-1,P),reason:a.reason},f.value=!0},Y=async a=>{try{v.value=!0,await y.deleteLeaveRecord(a.id),b.value=await I(),m.success("删除成功")}catch(e){console.error("Failed to delete record:",e),m.error("删除失败")}finally{v.value=!1}},H=async a=>{var e;a.preventDefault(),(e=$.value)==null||e.validate(async l=>{if(!l)try{v.value=!0;const o=new Date(u.value.startDate),i=new Date(u.value.endDate),t={memberId:u.value.memberId,startDate:`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`,endDate:`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,reason:u.value.reason,status:"请假中"};if(p.value&&N.value)await y.updateLeaveRecord(N.value,t),m.success("更新成功");else{if(!await M.getMember(t.memberId)){m.error("成员不存在");return}if((await y.getAllLeaveRecords()).some(L=>L.memberId===t.memberId&&(L.status==="请假中"||L.status==="等待销假"))){m.error("该成员已有未结束的请假记录");return}await y.addLeaveRecord(t),m.success("添加成功")}b.value=await I(),f.value=!1}catch(o){console.error("Failed to submit:",o),m.error(p.value?"更新失败":"添加失败")}finally{v.value=!1}})},K=a=>{D.value.page=a},G=a=>{D.value.pageSize=a;const e=Math.ceil(_.value.length/a);D.value.page>e&&(D.value.page=e)};let x=null;const J=()=>{x=window.setInterval(async()=>{b.value=await I()},6e4)};return Z(async()=>{await B(),b.value=await I(),J()}),ee(()=>{x&&clearInterval(x)}),(a,e)=>{const l=F("n-h2"),o=F("n-data-table"),i=F("n-card");return A(),ae(te,null,[r(i,null,{header:n(()=>[r(s(w),{align:"center",justify:"space-between"},{default:n(()=>[r(l,{style:{margin:"0",color:"#7B1FA2"}},{default:n(()=>e[9]||(e[9]=[T("请假记录")])),_:1}),r(s(h),{type:"primary",onClick:E},{default:n(()=>e[10]||(e[10]=[T(" 添加请假 ")])),_:1})]),_:1})]),default:n(()=>[r(s(w),{vertical:""},{default:n(()=>[r(s(w),null,{default:n(()=>[r(s(R),{value:S.value,"onUpdate:value":e[0]||(e[0]=t=>S.value=t),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:n(()=>[r(s(le),null,{default:n(()=>[r(s(ve))]),_:1})]),_:1},8,["value"]),r(s(j),{value:k.value,"onUpdate:value":e[1]||(e[1]=t=>k.value=t),placeholder:"状态筛选",clearable:"",options:[{label:"请假中",value:"请假中"},{label:"等待销假",value:"等待销假"},{label:"已结束",value:"已结束"}],style:{width:"120px"}},null,8,["value"]),r(s(Q),{value:c.value,"onUpdate:value":e[2]||(e[2]=t=>c.value=t),type:"daterange",clearable:"",placeholder:"选择日期范围",style:{width:"250px"}},null,8,["value"])]),_:1}),r(o,{columns:z,data:_.value,pagination:D.value,loading:v.value,"onUpdate:page":K,"onUpdate:pageSize":G},null,8,["data","pagination","loading"])]),_:1})]),_:1}),r(s(oe),{show:f.value,"onUpdate:show":e[8]||(e[8]=t=>f.value=t),preset:"card",title:p.value?"编辑请假记录":"添加请假",style:{width:"500px"}},{footer:n(()=>[r(s(w),{justify:"end"},{default:n(()=>[r(s(h),{onClick:e[7]||(e[7]=t=>f.value=!1)},{default:n(()=>e[11]||(e[11]=[T("取消")])),_:1}),r(s(h),{type:"primary",class:"submit-button",onClick:H},{default:n(()=>[T(re(p.value?"保存":"确定"),1)]),_:1})]),_:1})]),default:n(()=>[r(s(se),{ref_key:"formRef",ref:$,model:u.value,rules:O,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:n(()=>[p.value?ue("",!0):(A(),ne(s(C),{key:0,label:"选择成员",path:"memberId"},{default:n(()=>[r(s(j),{value:u.value.memberId,"onUpdate:value":e[3]||(e[3]=t=>u.value.memberId=t),options:U.value,placeholder:"请选择成员",filterable:"",clearable:""},null,8,["value","options"])]),_:1})),r(s(C),{label:"起始日期",path:"startDate"},{default:n(()=>[r(s(Q),{value:u.value.startDate,"onUpdate:value":e[4]||(e[4]=t=>u.value.startDate=t),type:"date",clearable:"",style:{width:"100%"}},null,8,["value"])]),_:1}),r(s(C),{label:"结束日期",path:"endDate"},{default:n(()=>[r(s(Q),{value:u.value.endDate,"onUpdate:value":e[5]||(e[5]=t=>u.value.endDate=t),type:"date",clearable:"",style:{width:"100%"},"is-date-disabled":t=>t<u.value.startDate},null,8,["value","is-date-disabled"])]),_:1}),r(s(C),{label:"请假原因",path:"reason"},{default:n(()=>[r(s(R),{value:u.value.reason,"onUpdate:value":e[6]||(e[6]=t=>u.value.reason=t),type:"textarea",placeholder:"请输入请假原因",rows:3},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])],64)}}}),ke=me(ge,[["__scopeId","data-v-7d922f94"]]);export{ke as default};
