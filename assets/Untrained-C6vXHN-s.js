import{M as S,L as M,Q as z}from"./leancloud-service-D8PKWX6z.js";import{S as P}from"./SearchOutline-D1q6xqfW.js";import{z as R}from"./zhCN-61bU8iQO.js";import{d as F,m as A,g as u,n as _,h as O,i as B,b as $,w as r,r as T,o as V,e as n,f as H,u as s,q as k,s as E,k as G,v as J,x as K,T as I,L as j,H as W,_ as X}from"./index-DXhrB1zA.js";const Y=F({__name:"Untrained",setup(Z){const L=A(),c=u(!1),q=async()=>{try{c.value=!0;const[e,a]=await Promise.all([S.getAllMembers(),M.getAllLeaveRecords()]);return e.filter(t=>a.some(o=>o.memberId===t.objectId&&(o.status==="请假中"||o.status==="等待销假"))||t.leaveRequest==="通过"?!1:t.stage==="未新训").map(t=>{const d=new Date(t.joinTime),l=Math.floor((new Date().getTime()-d.getTime())/(1e3*60*60*24)),D=Math.max(0,3-l),x=D>0?"催促新训":"未训退队";return x==="未训退队"&&!t.hasQuitRecord&&N(t),{id:t.objectId,nickname:t.nickname,qq:t.qq,gameId:t.gameId||"",joinTime:t.joinTime,stage:t.stage,daysLeft:D,status:x}})}catch(e){return console.error("Failed to load data:",e),L.error("加载数据失败"),[]}finally{c.value=!1}},N=async e=>{try{const a={memberId:e.objectId,memberName:e.nickname,memberQQ:e.qq,quitDate:new Date().toISOString().split("T")[0],quitType:"未训退队",reason:"加入3天内未参加新训",recorder:"System"};await z.addQuitRecord(a),await S.updateMember(e.objectId,{...e,hasQuitRecord:!0,status:"已退队"})}catch(a){console.error("Failed to handle auto quit:",a)}},y=u([]),p=u(""),f=u(null),i=u(null),g=u(null),m=u(null),w=_(()=>{let e=y.value;if(p.value){const a=p.value.toLowerCase();e=e.filter(t=>t.nickname.toLowerCase().includes(a)||t.qq.toLowerCase().includes(a))}if(f.value&&(e=e.filter(a=>a.status===f.value)),i.value&&i.value[0]&&i.value[1]){const a=new Date(i.value[0]).getTime(),t=new Date(i.value[1]).getTime();e=e.filter(d=>{const o=new Date(d.joinTime).getTime();return o>=a&&o<=t})}return g.value!==null&&(e=e.filter(a=>a.daysLeft>=g.value)),m.value!==null&&(e=e.filter(a=>a.daysLeft<=m.value)),e}),v=u({page:1,pageSize:10,itemCount:_(()=>w.value.length),showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:e})=>`共 ${e} 条数据`,suffix:({page:e,pageSize:a,pageCount:t})=>`第 ${e} 页 / 共 ${t} 页`}),Q=[{title:"昵称",key:"nickname",width:130,sorter:"default"},{title:"QQ号",key:"qq",width:130,sorter:(e,a)=>Number(e.qq)-Number(a.qq)},{title:"加入时间",key:"joinTime",width:130,sorter:(e,a)=>new Date(e.joinTime).getTime()-new Date(a.joinTime).getTime()},{title:"剩余天数",key:"daysLeft",width:100,sorter:(e,a)=>e.daysLeft-a.daysLeft,render(e){const a=e.daysLeft>1?"#2080f0":e.daysLeft>0?"#f0a020":"#d03050";return j("span",{style:{color:a}},e.daysLeft)}},{title:"状态",key:"status",width:100,sorter:(e,a)=>{const t={催促参训:0,未训退队:1};return t[e.status]-t[a.status]},render(e){return j(W,{type:e.status==="催促参训"?"warning":"error",round:!0},{default:()=>e.status})}}],b=e=>{v.value.page=e},U=e=>{v.value.pageSize=e;const a=Math.ceil(w.value.length/e);v.value.page>a&&(v.value.page=a)};let h=null;const C=()=>{h=window.setInterval(async()=>{y.value=await q()},6e4)};return O(async()=>{try{c.value=!0,y.value=await q()}catch(e){console.error("Failed to load initial data:",e),L.error("初始数据加载失败")}finally{c.value=!1}C()}),B(()=>{h&&clearInterval(h)}),(e,a)=>{const t=T("n-h2"),d=T("n-data-table"),o=T("n-card");return V(),$(o,null,{header:r(()=>[n(t,{style:{margin:"0",color:"#7B1FA2"}},{default:r(()=>a[5]||(a[5]=[H("未训退队")])),_:1})]),default:r(()=>[n(s(k),{vertical:""},{default:r(()=>[n(s(k),null,{default:r(()=>[n(s(E),{value:p.value,"onUpdate:value":a[0]||(a[0]=l=>p.value=l),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:r(()=>[n(s(G),null,{default:r(()=>[n(s(P))]),_:1})]),_:1},8,["value"]),n(s(J),{value:f.value,"onUpdate:value":a[1]||(a[1]=l=>f.value=l),placeholder:"状态筛选",clearable:"",options:[{label:"催促参训",value:"催促参训"},{label:"未训退队",value:"未训退队"}],style:{width:"120px"}},null,8,["value"]),n(s(K),{value:i.value,"onUpdate:value":a[2]||(a[2]=l=>i.value=l),type:"daterange",clearable:"",locale:s(R).DatePicker,placeholder:"加入时间范围",style:{width:"250px"}},null,8,["value","locale"]),n(s(I),{value:g.value,"onUpdate:value":a[3]||(a[3]=l=>g.value=l),placeholder:"最小剩余天数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"]),n(s(I),{value:m.value,"onUpdate:value":a[4]||(a[4]=l=>m.value=l),placeholder:"最大剩余天数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"])]),_:1}),n(d,{columns:Q,data:w.value,pagination:v.value,loading:c.value,"onUpdate:page":b,"onUpdate:pageSize":U},null,8,["data","pagination","loading"])]),_:1})]),_:1})}}}),ne=X(Y,[["__scopeId","data-v-0adc8e41"]]);export{ne as default};
