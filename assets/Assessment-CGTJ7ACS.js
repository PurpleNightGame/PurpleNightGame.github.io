import{M as P,A as M}from"./leancloud-service-D8PKWX6z.js";import{S as Z}from"./SearchOutline-D1q6xqfW.js";import{d as ee,m as ae,g as i,n as R,h as te,i as se,c as le,e as l,w as o,u as n,F as ne,r as T,o as ue,f as q,q as C,s as Q,k as re,v as k,x as V,T as F,B as z,y as oe,z as y,D as ie,L as I,H as de,_ as pe}from"./index-DXhrB1zA.js";import{C as ve}from"./CreateOutline-C305c4EG.js";const ce=ee({__name:"Assessment",setup(me){const f=ae(),v=i(!1),_=async()=>{try{v.value=!0;const a=await P.getAllMembers(),e=await M.getAllAssessments();return a.map(u=>{const s=e.find(d=>d.memberId===u.objectId);return{...u,id:u.objectId,assessmentMap:(s==null?void 0:s.assessmentMap)||"",assessmentStatus:(s==null?void 0:s.assessmentStatus)||"未通过",passDate:(s==null?void 0:s.passDate)||"",score:(s==null?void 0:s.score)||0,comment:(s==null?void 0:s.comment)||""}})}catch(a){return console.error("Failed to load data:",a),f.error("加载数据失败"),[]}finally{v.value=!1}},E=async a=>{try{const e={memberId:a.id||a.objectId,assessmentMap:a.assessmentMap,assessmentStatus:a.assessmentStatus,passDate:a.passDate,score:a.score,comment:a.comment},s=(await M.getAllAssessments()).find(O=>O.memberId===(a.id||a.objectId)&&O.assessmentMap===a.assessmentMap);s?await M.updateAssessment(s.objectId,e):await M.addAssessment(e);const{id:d,objectId:t,...p}=a,N={...p};a.assessmentStatus==="通过"&&(N.stage="紫夜",N.passDate=a.passDate),await P.updateMember(d||t,N)}catch(e){throw console.error("Failed to save data:",e),f.error("保存数据失败"),e}},m=i([]),S=i(""),b=i(null),w=i(null),c=i(null),h=i(null),x=i(null),A=R(()=>{let a=m.value;if(S.value){const e=S.value.toLowerCase();a=a.filter(u=>u.nickname.toLowerCase().includes(e)||u.qq.toLowerCase().includes(e))}if(b.value&&(a=a.filter(e=>e.assessmentMap===b.value)),w.value&&(a=a.filter(e=>e.assessmentStatus===w.value)),c.value&&c.value[0]&&c.value[1]){const e=new Date(c.value[0]).getTime(),u=new Date(c.value[1]).getTime();a=a.filter(s=>{if(!s.passDate)return!1;const d=new Date(s.passDate).getTime();return d>=e&&d<=u})}return h.value!==null&&(a=a.filter(e=>(e.score||0)>=h.value)),x.value!==null&&(a=a.filter(e=>(e.score||0)<=x.value)),a}),g=i({page:1,pageSize:10,itemCount:R(()=>A.value.length),showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:a})=>`共 ${a} 条数据`,suffix:({page:a,pageSize:e,pageCount:u})=>`第 ${a} 页 / 共 ${u} 页`}),H=a=>{g.value.page=a},Y=a=>{g.value.pageSize=a;const e=Math.ceil(A.value.length/a);g.value.page>e&&(g.value.page=e)},j=[{label:"加油站",value:"加油站"},{label:"蜘蛛",value:"蜘蛛"},{label:"213公寓",value:"213公寓"},{label:"海滨公寓",value:"海滨公寓"},{label:"大学",value:"大学"},{label:"医院",value:"医院"}],$=[{label:"通过",value:"通过"},{label:"未通过",value:"未通过"}],G=[{title:"昵称",key:"nickname",width:130,sorter:"default"},{title:"QQ号",key:"qq",width:130,sorter:(a,e)=>Number(a.qq)-Number(e.qq)},{title:"考核地图",key:"assessmentMap",width:110,sorter:"default"},{title:"考核状态",key:"assessmentStatus",width:110,sorter:(a,e)=>{const u={未通过:0,通过:1};return u[a.assessmentStatus||"未通过"]-u[e.assessmentStatus||"未通过"]},render(a){return I(de,{type:a.assessmentStatus==="通过"?"success":"error",round:!0},{default:()=>a.assessmentStatus||"未通过"})}},{title:"通过日期",key:"passDate",width:130,sorter:(a,e)=>!a.passDate&&!e.passDate?0:a.passDate?e.passDate?new Date(a.passDate).getTime()-new Date(e.passDate).getTime():-1:1},{title:"考核评分",key:"score",width:100,sorter:(a,e)=>(a.score||0)-(e.score||0),render(a){if(!a.score)return"未评分";const e=a.score>=90?"#18a058":a.score>=60?"#2080f0":"#d03050";return I("span",{style:{color:e}},a.score)}},{title:"考核评价",key:"comment",width:180,ellipsis:{tooltip:!0}},{title:"操作",key:"actions",width:70,align:"left",titleAlign:"left",fixed:"right",render(a){return I(z,{quaternary:!0,circle:!0,size:"small",style:"color: #7B1FA2",onClick:()=>K(a)},{icon:()=>I(ve)})}}],D=i(!1),B=i(null),L=i(null),r=i({assessmentMap:"",assessmentStatus:"",passDate:null,score:0,comment:""}),J={assessmentMap:{required:!0,message:"请选择考核地图",trigger:["blur","change"]},assessmentStatus:{required:!0,message:"请选择考核状态",trigger:["blur","change"]},passDate:{required:!0,type:"number",message:"请选择通过日期",trigger:["blur","change"],validator:(a,e)=>e?new Date(e)<=new Date:!1},score:{type:"number",message:"请输入有效的评分",trigger:["blur","change"],validator:(a,e)=>e==null?!0:e>=0&&e<=100}},K=a=>{L.value=a.id;const e=a.passDate?new Date(a.passDate).getTime():null;r.value={assessmentMap:a.assessmentMap||"",assessmentStatus:a.assessmentStatus||"未通过",passDate:e,score:a.score||0,comment:a.comment||""},D.value=!0},W=async a=>{var e;a.preventDefault(),(e=B.value)==null||e.validate(async u=>{if(!u){const s=r.value.passDate?new Date(r.value.passDate):null,d=s?`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`:"",t=m.value.findIndex(p=>p.id===L.value);if(t>-1)try{v.value=!0;const p={...m.value[t],assessmentMap:r.value.assessmentMap,assessmentStatus:r.value.assessmentStatus,passDate:d,score:r.value.score,comment:r.value.comment};await E(p),m.value[t]=p,f.success("更新成功"),D.value=!1}catch(p){console.error("Failed to update assessment:",p),f.error("更新失败")}finally{v.value=!1}}})};let U=null;const X=()=>{U=window.setInterval(async()=>{m.value=await _()},6e4)};return te(async()=>{try{v.value=!0,m.value=await _()}catch(a){console.error("Failed to load initial data:",a),f.error("初始数据加载失败")}finally{v.value=!1}X()}),se(()=>{U&&clearInterval(U)}),(a,e)=>{const u=T("n-h2"),s=T("n-data-table"),d=T("n-card");return ue(),le(ne,null,[l(d,null,{header:o(()=>[l(u,{style:{margin:"0",color:"#7B1FA2"}},{default:o(()=>e[13]||(e[13]=[q("考核管理")])),_:1})]),default:o(()=>[l(n(C),{vertical:""},{default:o(()=>[l(n(C),null,{default:o(()=>[l(n(Q),{value:S.value,"onUpdate:value":e[0]||(e[0]=t=>S.value=t),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:o(()=>[l(n(re),null,{default:o(()=>[l(n(Z))]),_:1})]),_:1},8,["value"]),l(n(k),{value:b.value,"onUpdate:value":e[1]||(e[1]=t=>b.value=t),placeholder:"考核地图",clearable:"",options:j,style:{width:"120px"}},null,8,["value"]),l(n(k),{value:w.value,"onUpdate:value":e[2]||(e[2]=t=>w.value=t),placeholder:"考核状态",clearable:"",options:$,style:{width:"120px"}},null,8,["value"]),l(n(V),{value:c.value,"onUpdate:value":e[3]||(e[3]=t=>c.value=t),type:"daterange",clearable:"",placeholder:"选择通过日期范围",style:{width:"250px"}},null,8,["value"]),l(n(F),{value:h.value,"onUpdate:value":e[4]||(e[4]=t=>h.value=t),placeholder:"最低分数",clearable:"",min:0,max:100,style:{width:"120px"}},null,8,["value"]),l(n(F),{value:x.value,"onUpdate:value":e[5]||(e[5]=t=>x.value=t),placeholder:"最高分数",clearable:"",min:0,max:100,style:{width:"120px"}},null,8,["value"])]),_:1}),l(s,{columns:G,data:A.value,pagination:g.value,loading:v.value,"onUpdate:page":H,"onUpdate:pageSize":Y},null,8,["data","pagination","loading"])]),_:1})]),_:1}),l(n(ie),{show:D.value,"onUpdate:show":e[12]||(e[12]=t=>D.value=t),preset:"card",title:"编辑考核信息",style:{width:"600px"}},{footer:o(()=>[l(n(C),{justify:"end"},{default:o(()=>[l(n(z),{onClick:e[11]||(e[11]=t=>D.value=!1)},{default:o(()=>e[14]||(e[14]=[q("取消")])),_:1}),l(n(z),{type:"primary",class:"submit-button",onClick:W},{default:o(()=>e[15]||(e[15]=[q(" 保存 ")])),_:1})]),_:1})]),default:o(()=>[l(n(oe),{ref_key:"formRef",ref:B,model:r.value,rules:J,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:o(()=>[l(n(y),{label:"考核地图",path:"assessmentMap"},{default:o(()=>[l(n(k),{value:r.value.assessmentMap,"onUpdate:value":e[6]||(e[6]=t=>r.value.assessmentMap=t),options:j,placeholder:"请选择考核地图"},null,8,["value"])]),_:1}),l(n(y),{label:"考核状态",path:"assessmentStatus"},{default:o(()=>[l(n(k),{value:r.value.assessmentStatus,"onUpdate:value":e[7]||(e[7]=t=>r.value.assessmentStatus=t),options:$,placeholder:"请选择考核状态"},null,8,["value"])]),_:1}),l(n(y),{label:"通过日期",path:"passDate"},{default:o(()=>[l(n(V),{value:r.value.passDate,"onUpdate:value":e[8]||(e[8]=t=>r.value.passDate=t),type:"date",clearable:"","is-date-disabled":t=>t>Date.now(),style:{width:"100%"}},null,8,["value","is-date-disabled"])]),_:1}),l(n(y),{label:"考核评分",path:"score"},{default:o(()=>[l(n(F),{value:r.value.score,"onUpdate:value":e[9]||(e[9]=t=>r.value.score=t),min:0,max:100,placeholder:"请输入评分(0-100)"},null,8,["value"])]),_:1}),l(n(y),{label:"考核评价",path:"comment"},{default:o(()=>[l(n(Q),{value:r.value.comment,"onUpdate:value":e[10]||(e[10]=t=>r.value.comment=t),type:"textarea",placeholder:"请输入考核评价",autosize:{minRows:3,maxRows:5}},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])],64)}}}),Se=pe(ce,[["__scopeId","data-v-0d672b1c"]]);export{Se as default};
