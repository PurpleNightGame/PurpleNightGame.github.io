import{c as W}from"./memberStatus-DvTvbu4x.js";import{M as A,L as X,Q as Y,a as Z,B as ee}from"./leancloud-service-D8PKWX6z.js";import{d as ae,m as le,g as r,n as z,h as te,i as se,c as ue,e as t,w as u,u as s,F as re,o as ne,O as oe,f as M,q as L,s as ie,k as ve,v,Q as de,j as ce,B as N,y as pe,z as D,D as fe,L as d,H as R,_ as ge}from"./index-DXhrB1zA.js";import{S as me}from"./SearchOutline-D1q6xqfW.js";import{C as be}from"./CreateOutline-C305c4EG.js";const ye=ae({__name:"MemberStatus",setup(he){const m=le(),T={leaveRequest:"未申请",status:"正常"},o=r(!1),k=async()=>{try{o.value=!0;const[e,a,l,g,x]=await Promise.all([A.getAllMembers(),X.getAllLeaveRecords(),Y.getAllQuitRecords(),Z.getAllBlacklistQuitRecords(),ee.getAllBlacklistRecords()]);return e.map(i=>{const J=a.some(C=>C.memberId===i.objectId&&(C.status==="请假中"||C.status==="等待销假")),K=W(i,x,a);return{...i,id:i.objectId,onLeave:J,leaveRequest:i.leaveRequest||"未申请",status:K}})}catch(e){return console.error("Failed to load data:",e),m.error("加载数据失败"),[]}finally{o.value=!1}},c=r([]),b=r(""),y=r(null),h=r(null),w=r(null),q=r(null),S=z(()=>{let e=c.value;if(b.value){const a=b.value.toLowerCase();e=e.filter(l=>l.nickname.toLowerCase().includes(a)||l.qq.toLowerCase().includes(a)||l.gameId&&l.gameId.toLowerCase().includes(a))}return y.value&&(e=e.filter(a=>a.stage===y.value)),h.value!==null&&(e=e.filter(a=>a.onLeave===h.value)),w.value&&(e=e.filter(a=>a.leaveRequest===w.value)),q.value&&(e=e.filter(a=>a.status===q.value)),e}),p=r({page:1,pageSize:10,itemCount:z(()=>S.value.length),showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:e})=>`共 ${e} 条数据`,suffix:({page:e,pageSize:a,pageCount:l})=>`第 ${e} 页 / 共 ${l} 页`}),U=[{label:"未申请",value:"未申请"},{label:"未通过",value:"未通过"},{label:"通过",value:"通过"}],j=[{label:"未新训",value:"未新训"},{label:"新训初期",value:"新训初期"},{label:"新训1期",value:"新训1期"},{label:"新训2期",value:"新训2期"},{label:"新训3期",value:"新训3期"},{label:"新训准考",value:"新训准考"},{label:"紫夜",value:"紫夜"}],B=[{label:"正常",value:"正常"},{label:"异常",value:"异常"},{label:"催促参训",value:"催促参训"},{label:"未训退队",value:"未训退队"},{label:"超时退队",value:"超时退队"},{label:"违规退队",value:"违规退队"}],O=e=>{switch(e){case"正常":return"success";case"异常":return"error";case"催促参训":case"催促新训":return"warning";case"未训退队":case"超时退队":case"违规退队":return"error";default:return"default"}},f=r(!1),Q=r(null),F=r(null),n=r({...T}),E={leaveRequest:{required:!0,message:"请选择留队申请状态",trigger:["blur","change"]},status:{required:!0,message:"请选择状态",trigger:["blur","change"]}},P=e=>{F.value=e.objectId,n.value={leaveRequest:e.leaveRequest||"未申请",status:e.status||"正常"},f.value=!0},$=async e=>{var a;e.preventDefault(),(a=Q.value)==null||a.validate(async l=>{if(!l)try{o.value=!0;const g=c.value.find(i=>i.objectId===F.value);if(!g)throw new Error("找不到要更新的成员");const x={...g,leaveRequest:n.value.leaveRequest,status:n.value.status};await A.updateMember(F.value,x),c.value=await k(),m.success("更新成功"),f.value=!1}catch(g){console.error("Failed to update member:",g),m.error("更新失败")}finally{o.value=!1}})},V=[{title:"昵称",key:"nickname",width:120},{title:"QQ号",key:"qq",width:120},{title:"游戏ID",key:"gameId",width:120},{title:"阶段",key:"stage",width:100,render(e){const a={未新训:"error",新训初期:"info",新训1期:"info",新训2期:"info",新训3期:"info",新训准考:"success",紫夜:"purple"},l={紫夜:{color:"#7B1FA2",backgroundColor:"#EDE7F6"}};return d(R,{type:a[e.stage],round:!0,style:e.stage==="紫夜"?l.紫夜:void 0},{default:()=>e.stage})}},{title:"请假状态",key:"onLeave",width:100,render(e){return d(R,{type:e.onLeave?"warning":"success",round:!0},{default:()=>e.onLeave?"请假中":"正常"})}},{title:"留队申请",key:"leaveRequest",width:100,render(e){return d(R,{type:{未申请:"default",未通过:"error",通过:"success"}[e.leaveRequest],round:!0},{default:()=>e.leaveRequest})}},{title:"状态",key:"status",width:100,render(e){return d(R,{type:O(e.status),round:!0},{default:()=>e.status})}},{title:"操作",key:"actions",width:100,render(e){return d(N,{quaternary:!0,circle:!0,size:"small",style:"color: #7B1FA2",onClick:()=>P(e)},{icon:()=>d(be)})}}],_=e=>{p.value.page=e},H=e=>{p.value.pageSize=e;const a=Math.ceil(S.value.length/e);p.value.page>a&&(p.value.page=a)};let I=null;const G=()=>{I=window.setInterval(async()=>{c.value=await k()},6e4)};return te(async()=>{try{o.value=!0,c.value=await k()}catch(e){console.error("Failed to load initial data:",e),m.error("初始数据加载失败")}finally{o.value=!1}G()}),se(()=>{I&&clearInterval(I)}),(e,a)=>(ne(),ue(re,null,[t(s(ce),null,{header:u(()=>[t(s(oe),{style:{margin:"0",color:"#7B1FA2"}},{default:u(()=>a[9]||(a[9]=[M("成员状态")])),_:1})]),default:u(()=>[t(s(L),{vertical:""},{default:u(()=>[t(s(L),null,{default:u(()=>[t(s(ie),{value:b.value,"onUpdate:value":a[0]||(a[0]=l=>b.value=l),placeholder:"搜索昵称/QQ号/游戏ID",clearable:"",style:{width:"200px"}},{prefix:u(()=>[t(s(ve),null,{default:u(()=>[t(s(me))]),_:1})]),_:1},8,["value"]),t(s(v),{value:y.value,"onUpdate:value":a[1]||(a[1]=l=>y.value=l),placeholder:"阶段筛选",clearable:"",options:j,style:{width:"120px"}},null,8,["value"]),t(s(v),{value:h.value,"onUpdate:value":a[2]||(a[2]=l=>h.value=l),placeholder:"请假状态",clearable:"",options:[{label:"请假中",value:!0},{label:"未请假",value:!1}],style:{width:"120px"}},null,8,["value"]),t(s(v),{value:w.value,"onUpdate:value":a[3]||(a[3]=l=>w.value=l),placeholder:"留队申请",clearable:"",options:U,style:{width:"120px"}},null,8,["value"]),t(s(v),{value:q.value,"onUpdate:value":a[4]||(a[4]=l=>q.value=l),placeholder:"状态筛选",clearable:"",options:B,style:{width:"120px"}},null,8,["value"])]),_:1}),t(s(de),{columns:V,data:S.value,pagination:p.value,loading:o.value,"onUpdate:page":_,"onUpdate:pageSize":H},null,8,["data","pagination","loading"])]),_:1})]),_:1}),t(s(fe),{show:f.value,"onUpdate:show":a[8]||(a[8]=l=>f.value=l),preset:"card",title:"编辑状态",style:{width:"500px"}},{footer:u(()=>[t(s(L),{justify:"end"},{default:u(()=>[t(s(N),{onClick:a[7]||(a[7]=l=>f.value=!1)},{default:u(()=>a[10]||(a[10]=[M("取消")])),_:1}),t(s(N),{type:"primary",class:"submit-button",onClick:$},{default:u(()=>a[11]||(a[11]=[M(" 保存 ")])),_:1})]),_:1})]),default:u(()=>[t(s(pe),{ref_key:"formRef",ref:Q,model:n.value,rules:E,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:u(()=>[t(s(D),{label:"留队申请",path:"leaveRequest"},{default:u(()=>[t(s(v),{value:n.value.leaveRequest,"onUpdate:value":a[5]||(a[5]=l=>n.value.leaveRequest=l),options:U,placeholder:"请选择申请状态"},null,8,["value"])]),_:1}),t(s(D),{label:"状态",path:"status"},{default:u(()=>[t(s(v),{value:n.value.status,"onUpdate:value":a[6]||(a[6]=l=>n.value.status=l),options:B,placeholder:"请选择状态"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])],64))}}),Fe=ge(ye,[["__scopeId","data-v-21919a8e"]]);export{Fe as default};
