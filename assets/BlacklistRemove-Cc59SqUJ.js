import{M,B as w}from"./leancloud-service-D8PKWX6z.js";import{S as z}from"./SearchOutline-D1q6xqfW.js";import{d as L,m as T,R as P,g as b,n as D,h as A,i as U,b as j,w as r,u as o,r as q,o as F,e as n,f as O,O as $,q as y,s as V,k as E,j as H,L as p,M as G,B as J,S as K,_ as W}from"./index-DXhrB1zA.js";const X=L({__name:"BlacklistRemove",setup(Y){const g=T();P();const m=b(!1),_=async()=>{try{m.value=!0;const e=await M.getAllMembers(),a=await w.getAllBlacklistRecords(),t=new Map;a.forEach(i=>{const s=t.get(i.memberId)||[];s.push(i),t.set(i.memberId,s)});const l=new Date,C=[];for(const[i,s]of t.entries()){s.sort((c,h)=>new Date(h.recordDate).getTime()-new Date(c.recordDate).getTime());const S=s[0],x=new Date(S.recordDate);if((l.getTime()-x.getTime())/(1e3*60*60*24)>30){const c=e.find(h=>h.objectId===i);C.push({memberId:i,memberName:c?c.nickname:"未知成员",memberQQ:c?c.qq:"",blacklistCount:s.length,blacklists:s})}}return C}catch(e){return console.error("Failed to load data:",e),g.error("加载数据失败"),[]}finally{m.value=!1}},u=b([]),f=b(""),v=D(()=>{let e=u.value;if(f.value){const a=f.value.toLowerCase();e=e.filter(t=>t.memberName.toLowerCase().includes(a)||t.memberQQ.toLowerCase().includes(a))}return e}),N=async e=>{try{m.value=!0;const t=(await w.getAllBlacklistRecords()).filter(l=>l.memberId===e.memberId);for(const l of t)await w.deleteBlacklistRecord(l.objectId);g.success("黑点消除成功"),u.value=u.value.filter(l=>l.memberId!==e.memberId)}catch(a){console.error("Failed to remove blacklist:",a),g.error("黑点消除失败")}finally{m.value=!1}},B=[{title:"成员昵称",key:"memberName",width:130,sorter:(e,a)=>e.memberName.localeCompare(a.memberName)},{title:"QQ号",key:"memberQQ",width:130,sorter:(e,a)=>Number(e.memberQQ)-Number(a.memberQQ)},{title:"黑点数量",key:"blacklistCount",width:100,sorter:(e,a)=>e.blacklistCount-a.blacklistCount},{title:"操作",key:"actions",width:80,render:e=>p(y,{justify:"start",align:"center",size:"small"},{default:()=>[p(G,{onPositiveClick:()=>N(e)},{default:()=>"确认消除该成员的所有黑点？",trigger:()=>p(J,{quaternary:!0,circle:!0,size:"small",style:"color: #18a058"},{icon:()=>p(K)})})]})}];let k=null;const I=()=>{k=window.setInterval(async()=>{u.value=await _()},6e4)};A(async()=>{u.value=await _(),I()}),U(()=>{k&&clearInterval(k)});const d=b({page:1,pageSize:10,showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:e})=>`共 ${e} 条数据`,suffix:({page:e,pageSize:a,pageCount:t})=>`第 ${e} 页 / 共 ${t} 页`,itemCount:D(()=>v.value.length)}),Q=e=>{d.value.page=e},R=e=>{d.value.pageSize=e;const a=Math.ceil(v.value.length/e);d.value.page>a&&(d.value.page=a)};return(e,a)=>{const t=q("n-data-table");return F(),j(o(H),null,{header:r(()=>[n(o($),{style:{margin:"0",color:"#7B1FA2"}},{default:r(()=>a[1]||(a[1]=[O("黑点消除记录")])),_:1})]),default:r(()=>[n(o(y),{vertical:""},{default:r(()=>[n(o(y),null,{default:r(()=>[n(o(V),{value:f.value,"onUpdate:value":a[0]||(a[0]=l=>f.value=l),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:r(()=>[n(o(E),null,{default:r(()=>[n(o(z))]),_:1})]),_:1},8,["value"])]),_:1}),n(t,{columns:B,data:v.value,loading:m.value,pagination:d.value,"onUpdate:page":Q,"onUpdate:pageSize":R},null,8,["data","loading","pagination"])]),_:1})]),_:1})}}}),se=W(X,[["__scopeId","data-v-aa0c0762"]]);export{se as default};
