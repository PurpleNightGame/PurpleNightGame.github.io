import{B as v,M as _,a as j,L as ne}from"./leancloud-service-D8PKWX6z.js";import{d as ue,m as de,g as c,n as P,h as ie,i as ce,c as me,e as t,w as o,u as l,F as ve,r as pe,o as E,q as k,O as fe,f as B,B as I,s as U,k as ge,v as L,x as V,j as be,t as ye,y as we,b as De,z as h,K as ke,D as Ie,L as g,H as he,M as Re,_ as Se}from"./index-DXhrB1zA.js";import{S as Ne}from"./SearchOutline-D1q6xqfW.js";import{C as Te}from"./CreateOutline-C305c4EG.js";import{T as Ce}from"./TrashOutline-8WT5DdKs.js";const Be=ue({__name:"BlacklistRecords",setup(Qe){const b=de(),p=c(!1),R=async()=>{try{p.value=!0;const a=await v.getAllBlacklistRecords(),e=await _.getAllMembers(),d=await v.getAllBlacklistRemoveRecords(),r=await j.getAllBlacklistQuitRecords(),C=await ne.getAllLeaveRecords(),x=new Map;a.forEach(n=>{const i=x.get(n.memberId)||[];i.push(n),x.set(n.memberId,i)});for(const[n,i]of x.entries()){i.sort((u,se)=>new Date(se.recordDate).getTime()-new Date(u.recordDate).getTime());const F=i[0],O=new Date(F.recordDate),M=new Date,le=(M.getTime()-O.getTime())/(1e3*60*60*24),re=d.some(u=>u.memberId===n&&new Date(u.recordDate).getTime()>O.getTime()),oe=C.some(u=>u.memberId===n&&u.status==="请假中");if(le>30&&!re&&!oe)try{await v.addBlacklistRemoveRecord({memberId:n,recordDate:M.toISOString().split("T")[0],reason:"自动消除（超过1个月无新增黑点）",recorder:"System"});for(const u of i)await v.deleteBlacklistRecord(u.id)}catch(u){console.error("Failed to process blacklist records:",u)}if(i.length>=4&&!r.some(u=>u.memberId===n))try{await j.addBlacklistQuitRecord({memberId:n,quitDate:M.toISOString().split("T")[0],reason:"自动记录（黑点数达到4个）",recorder:"System",quitType:"违规退队"})}catch(u){console.error("Failed to add blacklist quit record:",u)}}return(await v.getAllBlacklistRecords()).map(n=>{const i=e.find(F=>F.objectId===n.memberId);return{id:n.objectId,memberId:n.memberId,memberName:i?i.nickname:"未知成员",memberQQ:i?i.qq:"",level:n.level,recorder:n.recorder,recordDate:n.recordDate,reason:n.reason}})}catch(a){return console.error("Failed to load data:",a),b.error("加载数据失败"),[]}finally{p.value=!1}},w=c([]),S=c(""),N=c(null),f=c(null),Q=P(()=>{let a=w.value;if(S.value){const e=S.value.toLowerCase();a=a.filter(d=>d.memberName.toLowerCase().includes(e)||d.memberQQ.toLowerCase().includes(e)||d.recorder.toLowerCase().includes(e))}if(N.value&&(a=a.filter(e=>e.level===N.value)),f.value&&f.value[0]&&f.value[1]){const e=new Date(f.value[0]).getTime(),d=new Date(f.value[1]).getTime();a=a.filter(r=>{const C=new Date(r.recordDate).getTime();return C>=e&&C<=d})}return a}),A=c([]),H=async()=>{try{const a=await _.getAllMembers();A.value=a.map(e=>({label:`${e.nickname} (${e.qq})${e.gameId?` - ${e.gameId}`:""}`,value:e.objectId}))}catch(a){console.error("Failed to load member options:",a),b.error("加载成员列表失败")}},$=[{label:"警告",value:"警告"},{label:"严重警告",value:"严重警告"}],K=[{title:"成员昵称",key:"memberName",sorter:(a,e)=>a.memberName.localeCompare(e.memberName)},{title:"QQ号",key:"memberQQ",sorter:(a,e)=>Number(a.memberQQ)-Number(e.memberQQ)},{title:"等级",key:"level",sorter:(a,e)=>a.level.localeCompare(e.level),render:a=>{const e=a.level==="严重警告"?"error":"warning";return g(he,{type:e,round:!0},{default:()=>a.level})}},{title:"记录日期",key:"recordDate",sorter:(a,e)=>new Date(a.recordDate).getTime()-new Date(e.recordDate).getTime()},{title:"原因",key:"reason",sorter:(a,e)=>a.reason.localeCompare(e.reason)},{title:"记录人",key:"recorder",sorter:(a,e)=>a.recorder.localeCompare(e.recorder)},{title:"操作",key:"actions",width:80,render:a=>g(k,{justify:"center",align:"center",size:"small"},{default:()=>[g(I,{quaternary:!0,circle:!0,size:"small",style:"color: #7B1FA2",onClick:()=>W(a)},{icon:()=>g(Te)}),g(Re,{onPositiveClick:()=>X(a)},{default:()=>"确认删除？",trigger:()=>g(I,{quaternary:!0,circle:!0,size:"small",style:"color: #d03050"},{icon:()=>g(Ce)})})]})}],y=c(!1),m=c(!1),T=c(null),z=c(null),s=c({memberId:null,level:null,recorder:"",recordDate:null,reason:""}),Y={memberId:{required:!0,message:"请选择成员",trigger:"blur"},level:{required:!0,message:"请选择等级",trigger:"blur"},recorder:{required:!0,message:"请输入记录人",trigger:"blur"},recordDate:{required:!0,type:"number",message:"请选择记录日期",trigger:["blur","change"],validator:(a,e)=>e!=null&&!isNaN(e)},reason:{required:!0,message:"请输入原因",trigger:"blur"}},G=a=>a>Date.now(),J=()=>{m.value=!1,T.value=null,s.value={memberId:null,level:"",recorder:"",recordDate:null,reason:""},y.value=!0},W=a=>{m.value=!0,T.value=a.id,s.value={memberId:a.memberId,level:a.level,recorder:a.recorder,recordDate:a.recordDate?new Date(a.recordDate).getTime():null,reason:a.reason},y.value=!0},X=async a=>{try{p.value=!0,await v.deleteBlacklistRecord(a.id),w.value=await R(),b.success("删除成功")}catch(e){console.error("Failed to delete record:",e),b.error("删除失败")}finally{p.value=!1}},Z=async()=>{var a;try{await((a=z.value)==null?void 0:a.validate()),p.value=!0;const e=new Date(s.value.recordDate),d={memberId:s.value.memberId,level:s.value.level,recorder:s.value.recorder,recordDate:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,reason:s.value.reason};m.value&&T.value?await v.updateBlacklistRecord(T.value,d):await v.addBlacklistRecord(d),w.value=await R(),y.value=!1,b.success(m.value?"编辑成功":"添加成功")}catch(e){console.error("Failed to submit:",e),b.error(m.value?"编辑失败":"添加失败")}finally{p.value=!1}},D=c({page:1,pageSize:10,itemCount:P(()=>Q.value.length),showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:a})=>`共 ${a} 条数据`,suffix:({page:a,pageSize:e,pageCount:d})=>`第 ${a} 页 / 共 ${d} 页`}),ee=a=>{D.value.page=a},ae=a=>{D.value.pageSize=a;const e=Math.ceil(Q.value.length/a);D.value.page>e&&(D.value.page=e)};let q=null;const te=()=>{q=window.setInterval(async()=>{w.value=await R()},6e4)};return ie(async()=>{await H(),w.value=await R(),te()}),ce(()=>{q&&clearInterval(q)}),(a,e)=>{const d=pe("n-data-table");return E(),me(ve,null,[t(l(be),null,{header:o(()=>[t(l(k),{align:"center",justify:"space-between"},{default:o(()=>[t(l(fe),{style:{margin:"0",color:"#7B1FA2"}},{default:o(()=>e[10]||(e[10]=[B("黑点记录")])),_:1}),t(l(I),{type:"primary",onClick:J},{default:o(()=>e[11]||(e[11]=[B(" 添加记录 ")])),_:1})]),_:1})]),default:o(()=>[t(l(k),{vertical:""},{default:o(()=>[t(l(k),null,{default:o(()=>[t(l(U),{value:S.value,"onUpdate:value":e[0]||(e[0]=r=>S.value=r),placeholder:"搜索昵称/QQ号/记录人",clearable:"",style:{width:"200px"}},{prefix:o(()=>[t(l(ge),null,{default:o(()=>[t(l(Ne))]),_:1})]),_:1},8,["value"]),t(l(L),{value:N.value,"onUpdate:value":e[1]||(e[1]=r=>N.value=r),placeholder:"等级筛选",clearable:"",options:$,style:{width:"120px"}},null,8,["value"]),t(l(V),{value:f.value,"onUpdate:value":e[2]||(e[2]=r=>f.value=r),type:"daterange",clearable:"",placeholder:"选择记录日期范围",style:{width:"250px"}},null,8,["value"])]),_:1}),t(d,{columns:K,data:Q.value,pagination:D.value,loading:p.value,"onUpdate:page":ee,"onUpdate:pageSize":ae},null,8,["data","pagination","loading"])]),_:1})]),_:1}),t(l(Ie),{show:y.value,"onUpdate:show":e[9]||(e[9]=r=>y.value=r),preset:"card",title:m.value?"编辑黑点记录":"添加黑点记录",style:{width:"500px"}},{footer:o(()=>[t(l(k),{justify:"end"},{default:o(()=>[t(l(I),{onClick:e[8]||(e[8]=r=>y.value=!1)},{default:o(()=>e[12]||(e[12]=[B("取消")])),_:1}),t(l(I),{type:"primary",class:"submit-button",onClick:Z},{default:o(()=>[B(ye(m.value?"保存":"确定"),1)]),_:1})]),_:1})]),default:o(()=>[t(l(we),{ref_key:"formRef",ref:z,model:s.value,rules:Y,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:o(()=>[m.value?ke("",!0):(E(),De(l(h),{key:0,label:"选择成员",path:"memberId"},{default:o(()=>[t(l(L),{value:s.value.memberId,"onUpdate:value":e[3]||(e[3]=r=>s.value.memberId=r),options:A.value,placeholder:"请选择成员",filterable:"",clearable:""},null,8,["value","options"])]),_:1})),t(l(h),{label:"等级",path:"level"},{default:o(()=>[t(l(L),{value:s.value.level,"onUpdate:value":e[4]||(e[4]=r=>s.value.level=r),options:$,placeholder:"请选择等级"},null,8,["value"])]),_:1}),t(l(h),{label:"记录人",path:"recorder"},{default:o(()=>[t(l(U),{value:s.value.recorder,"onUpdate:value":e[5]||(e[5]=r=>s.value.recorder=r),placeholder:"请输入记录人"},null,8,["value"])]),_:1}),t(l(h),{label:"记录日期",path:"recordDate"},{default:o(()=>[t(l(V),{value:s.value.recordDate,"onUpdate:value":e[6]||(e[6]=r=>s.value.recordDate=r),type:"date",clearable:"","is-date-disabled":G,style:{width:"100%"}},null,8,["value"])]),_:1}),t(l(h),{label:"原因",path:"reason"},{default:o(()=>[t(l(U),{value:s.value.reason,"onUpdate:value":e[7]||(e[7]=r=>s.value.reason=r),type:"textarea",placeholder:"请输入原因",rows:3},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])],64)}}}),$e=Se(Be,[["__scopeId","data-v-a1fbf09a"]]);export{$e as default};
