import{M as F,L as R}from"./leancloud-service-D8PKWX6z.js";import{S as B}from"./SearchOutline-D1q6xqfW.js";import{z as O}from"./zhCN-61bU8iQO.js";import{d as b,m as j,g as u,n as x,h as A,i as Q,b as $,w as f,r as k,o as V,e as s,f as H,u as r,q as N,s as E,k as G,v as J,x as K,T as C,L as g,H as W,B as X,M as Y,_ as Z}from"./index-DXhrB1zA.js";import{T as ee}from"./TrashOutline-8WT5DdKs.js";const ae=b({__name:"Reminders",setup(te){const p=j(),v=u(!1),_=async()=>{try{v.value=!0;const[e,a]=await Promise.all([F.getAllMembers(),R.getAllLeaveRecords()]);return e.filter(t=>{if(t.passDate||a.some(L=>L.memberId===t.objectId&&(L.status==="请假中"||L.status==="等待销假"))||t.leaveRequest==="通过"||!t.lastTrainingDate||t.lastTrainingDate===""||t.lastTrainingDate==="null")return!1;const i=new Date(t.lastTrainingDate);return Math.floor((new Date().getTime()-i.getTime())/(1e3*60*60*24))>=7}).map(t=>{const l=t.lastTrainingDate,i=q(l),n=S(l);return{id:t.objectId,nickname:t.nickname,qq:t.qq,gameId:t.gameId||"",joinTime:t.joinTime,stage:t.stage,lastTrainingDate:l,daysLeft:i,status:n}})}catch(e){return console.error("Failed to load data:",e),p.error("加载数据失败"),[]}finally{v.value=!1}},d=u([]);x(()=>d.value.map(e=>({...e,daysLeft:q(e.lastTrainingDate),status:S(e.lastTrainingDate)})));const q=e=>{if(!e)return 0;const a=new Date(e),l=Math.floor((new Date().getTime()-a.getTime())/(1e3*60*60*24));return l<7?-1:l>=7?Math.max(0,3-(l-7)):0},S=e=>{if(!e)return"催促新训";const a=new Date(e);return Math.floor((new Date().getTime()-a.getTime())/(1e3*60*60*24))>=10?"超时退队":"催促新训"},y=u(""),m=u(null),c=u(null),D=u(null),w=u(null),o=u({page:1,pageSize:10,showSizePicker:!0,pageSizes:[10,20,30,40,50,100],prefix:({itemCount:e})=>`共 ${e} 条数据`,suffix:({page:e,pageSize:a,pageCount:t})=>`第 ${e} 页 / 共 ${t} 页`,itemCount:x(()=>h.value.length)}),M=e=>{o.value.page=e},I=e=>{o.value.pageSize=e;const a=Math.ceil(h.value.length/e);o.value.page>a&&(o.value.page=a)},h=x(()=>{let e=d.value;if(y.value){const a=y.value.toLowerCase();e=e.filter(t=>t.nickname.toLowerCase().includes(a)||t.qq.toLowerCase().includes(a))}if(m.value&&(e=e.filter(a=>a.status===m.value)),c.value&&c.value[0]&&c.value[1]){const a=new Date(c.value[0]).getTime(),t=new Date(c.value[1]).getTime();e=e.filter(l=>{if(!l.lastTrainingDate)return!1;const i=new Date(l.lastTrainingDate).getTime();return i>=a&&i<=t})}return D.value!==null&&(e=e.filter(a=>a.daysLeft>=D.value)),w.value!==null&&(e=e.filter(a=>a.daysLeft<=w.value)),e}),z=[{title:"昵称",key:"nickname",width:130,sorter:"default"},{title:"QQ号",key:"qq",width:130,sorter:(e,a)=>Number(e.qq)-Number(a.qq)},{title:"最后一次新训日期",key:"lastTrainingDate",width:150,sorter:(e,a)=>new Date(e.lastTrainingDate).getTime()-new Date(a.lastTrainingDate).getTime()},{title:"剩余天数",key:"daysLeft",width:100,sorter:(e,a)=>e.daysLeft-a.daysLeft,render(e){const a=e.daysLeft>1?"#2080f0":e.daysLeft>0?"#f0a020":"#d03050";return g("span",{style:{color:a}},e.daysLeft)}},{title:"状态",key:"status",width:100,sorter:(e,a)=>{const t={催促新训:0,超时退队:1};return t[e.status]-t[a.status]},render(e){return g(W,{type:e.status==="催促新训"?"warning":"error",round:!0},{default:()=>e.status})}},{title:"操作",key:"actions",width:80,render(e){return g(Y,{onPositiveClick:()=>U(e)},{trigger:()=>g(X,{quaternary:!0,circle:!0,size:"small",style:"color: #d03050"},{icon:()=>g(ee)}),default:()=>"确定从催促名单中移除吗？"})}}];let T=null;const P=()=>{T=window.setInterval(async()=>{d.value=await _()},6e4)};A(async()=>{try{v.value=!0,d.value=await _()}catch(e){console.error("Failed to load initial data:",e),p.error("初始数据加载失败")}finally{v.value=!1}P()}),Q(()=>{T&&clearInterval(T)});const U=e=>{try{d.value=d.value.filter(l=>l.id!==e.id);const a=o.value.page,t=d.value.length;o.value={...o.value,itemCount:t,page:t===0?1:Math.ceil(t/o.value.pageSize)<a?Math.max(1,a-1):a},p.success("已从催促名单中移除")}catch(a){console.error("Failed to delete reminder:",a),p.error("操作失败，请重试")}};return(e,a)=>{const t=k("n-h2"),l=k("n-data-table"),i=k("n-card");return V(),$(i,null,{header:f(()=>[s(t,{style:{margin:"0",color:"#7B1FA2"}},{default:f(()=>a[5]||(a[5]=[H("催促名单")])),_:1})]),default:f(()=>[s(r(N),{vertical:""},{default:f(()=>[s(r(N),null,{default:f(()=>[s(r(E),{value:y.value,"onUpdate:value":a[0]||(a[0]=n=>y.value=n),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:f(()=>[s(r(G),null,{default:f(()=>[s(r(B))]),_:1})]),_:1},8,["value"]),s(r(J),{value:m.value,"onUpdate:value":a[1]||(a[1]=n=>m.value=n),placeholder:"状态筛选",clearable:"",options:[{label:"催促新训",value:"催促新训"},{label:"超时退队",value:"超时退队"}],style:{width:"120px"}},null,8,["value"]),s(r(K),{value:c.value,"onUpdate:value":a[2]||(a[2]=n=>c.value=n),type:"daterange",clearable:"",locale:r(O).DatePicker,placeholder:"最后一次新训日期范围",style:{width:"250px"}},null,8,["value","locale"]),s(r(C),{value:D.value,"onUpdate:value":a[3]||(a[3]=n=>D.value=n),placeholder:"最小剩余天数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"]),s(r(C),{value:w.value,"onUpdate:value":a[4]||(a[4]=n=>w.value=n),placeholder:"最大剩余天数",clearable:"",min:0,style:{width:"120px"}},null,8,["value"])]),_:1}),s(l,{columns:z,data:h.value,pagination:o.value,loading:v.value,"onUpdate:page":M,"onUpdate:pageSize":I},null,8,["data","pagination","loading"])]),_:1})]),_:1})}}}),ue=Z(ae,[["__scopeId","data-v-3e683fe2"]]);export{ue as default};
