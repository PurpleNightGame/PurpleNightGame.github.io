import{L as _,M as T}from"./leancloud-service-D8PKWX6z.js";import{S as L}from"./SearchOutline-D1q6xqfW.js";import{d as x,m as I,g as d,n as U,h as M,i as F,b as B,w as u,r as y,o as P,e as s,f as q,u as i,q as h,s as z,k as A,v as E,x as R,L as m,H as $,M as j,B as O,_ as V}from"./index-DXhrB1zA.js";import{C as H}from"./CreateOutline-C305c4EG.js";const Y=x({__name:"EndLeave",setup(G){const f=I(),c=d(!1),v=d(""),p=d(null),o=d(null),w=d({page:1,pageSize:10,itemCount:0,showSizePicker:!0,pageSizes:[10,20,30,40]}),N=t=>{w.value.page=t},b=async()=>{try{c.value=!0;const t=await _.getAllLeaveRecords(),e=await T.getAllMembers();return t.filter(a=>a.status==="等待销假").map(a=>{const r=e.find(l=>l.objectId===a.memberId);return{id:a.objectId,memberId:a.memberId,memberName:r?r.nickname:"未知成员",memberQQ:r?r.qq:"",startDate:a.startDate,endDate:a.endDate,endedDate:"",status:a.status,reason:a.reason}})}catch(t){return console.error("Failed to load data:",t),f.error("加载数据失败"),[]}finally{c.value=!1}},g=d([]),S=U(()=>{let t=g.value;if(v.value){const e=v.value.toLowerCase();t=t.filter(n=>n.memberName.toLowerCase().includes(e)||n.memberQQ.toLowerCase().includes(e))}if(p.value&&(t=t.filter(e=>e.status===p.value)),o.value&&o.value[0]&&o.value[1]){const e=new Date(o.value[0]),n=new Date(o.value[1]);t=t.filter(a=>{const r=new Date(Date.UTC(...a.startDate.split("-").map(Number),0,0,0)),l=new Date(Date.UTC(...a.endDate.split("-").map(Number),0,0,0));return r>=e&&r<=n||l>=e&&l<=n||r<=e&&l>=n})}return w.value.itemCount=t.length,t}),k=[{title:"昵称",key:"memberName",width:130,sorter:"default"},{title:"QQ号",key:"memberQQ",width:130,sorter:(t,e)=>Number(t.memberQQ)-Number(e.memberQQ)},{title:"起始日期",key:"startDate",width:130,sorter:(t,e)=>new Date(t.startDate).getTime()-new Date(e.startDate).getTime()},{title:"结束日期",key:"endDate",width:130,sorter:(t,e)=>new Date(t.endDate).getTime()-new Date(e.endDate).getTime()},{title:"请假原因",key:"reason",width:200},{title:"状态",key:"status",width:100,render(t){return m($,{type:"warning",round:!0},{default:()=>t.status})}},{title:"操作",key:"actions",width:130,render(t){return m(h,{align:"center"},{default:()=>[m(j,{onPositiveClick:()=>C(t)},{trigger:()=>m(O,{quaternary:!0,circle:!0,size:"small",style:"color: #18a058"},{icon:()=>m(H)}),default:()=>"确定销假吗？"})]})}}],C=async t=>{try{c.value=!0;const e=new Date,n=`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`;await _.endLeave(t.id,n),f.success("销假成功"),g.value=await b()}catch(e){console.error("Failed to end leave:",e),f.error("销假失败")}finally{c.value=!1}};let D=null;const Q=()=>{D=window.setInterval(async()=>{g.value=await b()},6e4)};return M(async()=>{g.value=await b(),Q()}),F(()=>{D&&clearInterval(D)}),(t,e)=>{const n=y("n-h2"),a=y("n-data-table"),r=y("n-card");return P(),B(r,null,{header:u(()=>[s(n,{style:{margin:"0",color:"#7B1FA2"}},{default:u(()=>e[3]||(e[3]=[q("结束请假")])),_:1})]),default:u(()=>[s(i(h),{vertical:""},{default:u(()=>[s(i(h),null,{default:u(()=>[s(i(z),{value:v.value,"onUpdate:value":e[0]||(e[0]=l=>v.value=l),placeholder:"搜索昵称/QQ号",clearable:"",style:{width:"200px"}},{prefix:u(()=>[s(i(A),null,{default:u(()=>[s(i(L))]),_:1})]),_:1},8,["value"]),s(i(E),{value:p.value,"onUpdate:value":e[1]||(e[1]=l=>p.value=l),placeholder:"状态筛选",clearable:"",options:[{label:"等待销假",value:"等待销假"},{label:"已结束",value:"已结束"}],style:{width:"120px"}},null,8,["value"]),s(i(R),{value:o.value,"onUpdate:value":e[2]||(e[2]=l=>o.value=l),type:"daterange",clearable:"",placeholder:"选择结束日期范围",style:{width:"250px"}},null,8,["value"])]),_:1}),s(a,{columns:k,data:S.value,pagination:w.value,loading:c.value,"onUpdate:page":N},null,8,["data","pagination","loading"])]),_:1})]),_:1})}}}),Z=V(Y,[["__scopeId","data-v-5c08735d"]]);export{Z as default};
